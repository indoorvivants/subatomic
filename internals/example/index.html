<html><head><title>Subatomic: Example from scratch</title><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.5.0/build/styles/monokai-sublime.min.css" /><script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.5.0/build/highlight.min.js"></script><script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.5.0/build/languages/scala.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="/assets/script.js"></script><link rel="stylesheet" href="/assets/styles.css" /><script src="/assets/search.js"></script><script src="/assets/search-index.js"></script><meta charset="UTF-8" /></head><body><div class="container"><header class="main-header"><div class="site-title"><h1><a href="/">Subatomic</a></h1><small>Watch this space, but please don't use it yet</small></div><div id="searchContainer" class="searchContainer"></div><div class="site-links"><a href="https://github.com/indoorvivants/subatomic"><img src="https://cdn.svgporn.com/logos/github-icon.svg" class="gh-logo" /></a></div></header><div><a class="nav-btn" href="/index.html">Home</a><a class="nav-btn" href="/builders/index.html">Builders</a><a class="nav-btn" href="/internals/index.html">Internals</a><div><a class="subnav-btn subnav-selected" href="/internals/example/index.html">Example from scratch</a><a class="subnav-btn" href="/internals/raw/index.html">Raw API</a><a class="subnav-btn" href="/internals/classpath/index.html">Mdoc and classpath</a></div></div><hr /><div><p>We're going build a simple website with statically checked Scala code in Markdown.</p>
<p>Tools we will use:</p>
<ul>
<li><a href="https://ammonite.io">Ammonite</a>, for writing the entire site builder in a single Scala script</li>
<li><a href="https://scalameta.org/mdoc">Mdoc</a> to compile code examples in markdown</li>
<li><a href="https://lihaoyi.com/scalatags">ScalaTags</a> to generate HTML</li>
</ul>
<p>ScalaTags is not mandated by Subatomic (neither is writing it using Ammonite), but if we're already writing everything in Scala, why not HTML, too :-)</p>
<p>This document is copying the example outlined in the <a href="https://github.com/indoorvivants/subatomic/tree/master/docs/example">repo</a></p>
<h2>Folder structure</h2>
<p>Our example folder structure will look like this:</p>
<pre><code class="language-bash"># static files
assets/
    bootstrap.css
    highlight.js
    hightlight-scala.js
    highlight-theme.css
    script.js
    styles.css
pages/
    index.md # will become index.html, not processed with mdoc
    scala-usage.md # will become scala-usage.html, processed with mdoc
    scala-js-usage.md # will become scala-js-usage.html, processed with mdoc
build.sc # static site builder
</code></pre>
<h2>Goals</h2>
<p>What do we want to achieve:</p>
<ul>
<li>
<p>All static assets copied into the built site, accessible via same relative paths</p>
</li>
<li>
<p><code>scala-usage.md</code> will contain some code built with <a href="https://typelevel.org/cats-effect/">Cats-effect</a> library and we want the snippets to be compiled and executed</p>
</li>
<li>
<p><code>scala-js-usage.md</code> will contain some code built with <a href="https://laminar.dev">Laminar</a> library for Scala.js and we want the snippets to become interactive</p>
</li>
<li>
<p>We want to be able to deploy our site to a relative URL of our choosing</p>
<p>This matters when you maintain several sites from the same domain, and want to, say, build a static site for your library at <strong>https://indoorvivants.com/subatomic</strong>,
and want to maintain your abandoned blog at <strong>https://indoorvivants.com/blog</strong></p>
<p>All links should work as expected.</p>
</li>
</ul>
<h2>Dependencies and imports</h2>
<pre><code class="language-scala">import $ivy.`com.indoorvivants::subatomic-core:0.0.4+3-efbffb2e-SNAPSHOT`
import $ivy.`com.lihaoyi::scalatags:0.9.1`
</code></pre>
<pre><code class="language-scala">import subatomic._

import ammonite.ops._
</code></pre>
<h2>Defining content models</h2>
<p>We're going to reperesent our content model very simply:</p>
<pre><code class="language-scala">sealed trait Content

case class ScalaPage(
    title: String,
    path: os.Path,
    dependencies: Set[String]
) extends Content

case class ScalaJSPage(
    title: String,
    path: os.Path,
    dependencies: List[String]
) extends Content

case class MarkdownPage(title: String, path: os.Path) extends Content
</code></pre>
<ul>
<li>
<p><code>MarkdownPage</code> - a page with no Scala snippets that we just want to render as HTML</p>
</li>
<li>
<p><code>ScalaPage</code> - a page that will be compiled using Mdoc (potentially with a list of dependencies)</p>
</li>
<li>
<p><code>ScalaJSPage</code> - same as <code>ScalaPage</code>, but will be compiled into Scala.js (JavaScript) and examples will be embedded.</p>
</li>
</ul>
<p>Let's define our site map, by passing a version of subatomic itself:</p>
<pre><code class="language-scala">object Content {
  def Pages(root: os.Path): Vector[(SitePath, Content)] = {
    Vector(
      SiteRoot / &quot;index.html&quot; -&gt; MarkdownPage(
        &quot;Home&quot;,
        root / &quot;pages&quot; / &quot;index.md&quot;
      ),
      SiteRoot / &quot;scala-usage.html&quot; -&gt; ScalaPage(
        &quot;Scala usage&quot;,
        root / &quot;pages&quot; / &quot;scala-usage.md&quot;,
        Set(&quot;org.typelevel::cats-effect:2.2.0&quot;)
      ),
      SiteRoot / &quot;scala-js-usage.html&quot; -&gt; ScalaJSPage(
        &quot;Scala.js usage&quot;,
        root / &quot;pages&quot; / &quot;scala-js-usage.md&quot;,
        List(&quot;com.raquo::laminar_sjs1:0.11.0&quot;)
      )
    )
  }
}
</code></pre>
<h2>Templates</h2>
<p>Let's create a simple template with Bootstrap styles and Highlight.js dark theme for syntax highlighting:</p>
<pre><code class="language-scala">class Template(linker: Linker) {
  import scalatags.Text.all._
  import scalatags.Text.TypedTag

  def RawHTML(rawHtml: String) = div(raw(rawHtml))

  def main(title: String, content: String): String =
    main(title, RawHTML(content))

  def main(title: String, content: TypedTag[_]): String = {
    html(
      head(
        scalatags.Text.tags2.title(title),
        link(
          rel := &quot;stylesheet&quot;,
          href := linker.unsafe(_ / &quot;assets&quot; / &quot;highlight-theme.css&quot;)
        ),
        link(
          rel := &quot;stylesheet&quot;,
          href := linker.unsafe(_ / &quot;assets&quot; / &quot;bootstrap.css&quot;)
        ),
        script(src := linker.unsafe(_ / &quot;assets&quot; / &quot;highlight.js&quot;)),
        script(src := linker.unsafe(_ / &quot;assets&quot; / &quot;highlight-scala.js&quot;)),
        script(src := linker.unsafe(_ / &quot;assets&quot; / &quot;script.js&quot;))
      ),
      body(
        div(
          cls := &quot;container&quot;,
          div(
            cls := &quot;row&quot;,
            div(
              cls := &quot;col-9&quot;,
              h1(title),
              content // this is what our pages will be rendered as
            )
          )
        )
      )
    ).render
  }
}
</code></pre>
<ul>
<li>
<p>We use <code>Linker</code> interface to resolve links on the site</p>
</li>
<li>
<p>We define a helper method <code>RawHTML</code> which takes a <code>String</code> - markdown processor
will produce resulting HTML as a String.</p>
</li>
</ul>
<h2>Configurting the site</h2>
<p>Take a look at the whole function, it's excessively commented:</p>
<pre><code class="language-scala">def createSite(
    contentRoot: os.Path = os.pwd,
    siteRoot: SitePath
): Site[Content] = {
  // creating a full site map
  val raw = Content.Pages(contentRoot)

  // shift all the content to match the site prefix (siteRoot)
  val content = raw.map {
    case (rawLocation, content) =&gt;
      rawLocation.prepend(siteRoot) -&gt; content
  }

  // helper to resolve links to their correct
  // values with regard to site root
  val linker = new Linker(raw, siteRoot)
  
  val template = new Template(linker)

   // wrapper around flexmark
  val markdown = Markdown(
    // optional:
    //   relativizes all  links in markdown
    //   relative to the path (in this case siteRoot)
    RelativizeLinksExtension(siteRoot.toRelPath)
  )

  val scalaPageProcessor =
    MdocProcessor.create[ScalaPage]() {
      case ScalaPage(_, markdown, deps) =&gt; MdocFile(markdown, deps.toSet)
    }

  val scalaJSPageProcessor =
    MdocJSProcessor.create[ScalaJSPage]() {
      case ScalaJSPage(_, markdown, deps) =&gt; MdocFile(markdown, deps.toSet)
    }
  
  def renderMarkdownFile(title: String, filepath: os.Path): Page = {
    val renderedHtml = markdown.renderToString(filepath)
    val fullPageHtml = template.main(title, renderedHtml)

    Page(fullPageHtml)
  }

  val scalaPageRenderer: Processor[ScalaPage, SiteAsset] = scalaPageProcessor
    // after mdoc processes the page, we want to convert markdown to HTML 
    .map(result =&gt; renderMarkdownFile(result.original.title, result.resultFile))

  // Pages with Scala.js examples are a bit special
  // Mdoc produces 3 files associated with each markdown file you give it
  // We need to be very careful about placing the JS files 
  // in the correct locations (because they're already references in generated
  // markdown)
  def scalaJSPageRenderer(mainDocPath: SitePath): Processor[ScalaJSPage, Map[SitePath, SiteAsset]] =
    scalaJSPageProcessor.map { result =&gt;
      Map(
        // Markdown file to become the page itself
        mainDocPath -&gt; renderMarkdownFile(result.original.title, result.markdownFile),
        // Implementations of functions associated with each snippet
        mainDocPath.up / result.jsSnippetsFile.last -&gt; CopyOf(result.jsSnippetsFile),
        // general file that triggers the snippets' code when page is loaded
        mainDocPath.up / &quot;mdoc.js&quot; -&gt; CopyOf(result.jsInitialisationFile)
      )
    }

  Site
    // we're just adding content to call populate later, 
    // at the moment the site is empty
    .init(content) 
    // populate the site by going over every piece of content
    // and applying a function that can add pages to the site
    .populate {
      case (site, content) =&gt;
        content match {
          case (sitePath, doc: ScalaPage) =&gt;
            // we're telling subatomic to use scalaPageRenderer
            // to process this piece of content
            // when the site is built
            site.addProcessed(sitePath, scalaPageRenderer, doc)

          case (sitePath, doc: MarkdownPage) =&gt;
            // we don't need to do any special processing on
            // regular markdown pages (calling mdoc is expensive)
            // so we can just use addPage
            site.add(sitePath, renderMarkdownFile(doc.title, doc.path))

          case (sitePath, doc: ScalaJSPage) =&gt;
            // we're using a special 
            site.addProcessed(scalaJSPageRenderer(sitePath), doc)
        }
    }
    // copy all static files to be served at /assets/ on our site
    .copyAll(contentRoot / &quot;assets&quot;, SiteRoot / &quot;assets&quot;)
}

val site = createSite(
  contentRoot = os.pwd / &quot;docs&quot; / &quot;example&quot;,
  siteRoot    = SiteRoot / &quot;example&quot; / &quot;subatomic-example&quot;
)
// site: Site[Content] = Site(
//   Vector(
//     Ready(
//       SitePath(List(&quot;example&quot;, &quot;subatomic-example&quot;, &quot;index.html&quot;)),
//       Page(
//         &quot;&quot;&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Home&lt;/title&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;/example/subatomic-example/assets/highlight-theme.css&quot; /&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;/example/subatomic-example/assets/bootstrap.css&quot; /&gt;&lt;script src=&quot;/example/subatomic-example/assets/highlight.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;/example/subatomic-example/assets/highlight-scala.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;/example/subatomic-example/assets/script.js&quot;&gt;&lt;/script&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;container&quot;&gt;&lt;div class=&quot;row&quot;&gt;&lt;div class=&quot;col-9&quot;&gt;&lt;h1&gt;Home&lt;/h1&gt;&lt;div&gt;&lt;p&gt;Welcome to Subatomic!&lt;/p&gt;
// &lt;p&gt;&lt;a href=&quot;/example/subatomic-example/scala-usage.html&quot;&gt;Scala usage&lt;/a&gt;&lt;/p&gt;
// &lt;p&gt;&lt;a href=&quot;/example/subatomic-example/scala-js-usage.html&quot;&gt;Scala.js usage&lt;/a&gt;&lt;/p&gt;
// &lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;&quot;&quot;
//       )
//     ),
//     Delayed(
//       SitePath(List(&quot;example&quot;, &quot;subatomic-example&quot;, &quot;scala-usage.html&quot;)),
//       subatomic.Site$$Lambda$1656/1389056701@5bdef8ee,
//       &quot;ScalaPage(Scala usage,/home/runner/work/subatomic/subatomic/docs/example/pages/scala-usage.md,Set(org.typelevel::cats-effect:2.2.0))&quot;
//     ),
//     DelayedMany(
//       subatomic.Site$$Lambda$2395/507017588@bb896e9,
//       &quot;ScalaJSPage(Scala.js usage,/home/runner/work/subatomic/subatomic/docs/example/pages/scala-js-usage.md,List(com.raquo::laminar_sjs1:0.11.0))&quot;
//     ),
//     Ready(
//       SitePath(List(&quot;assets&quot;, &quot;highlight-theme.css&quot;)),
//       CopyOf(
//         /home/runner/work/subatomic/subatomic/docs/example/assets/highlight-theme.css
//       )
//     ),
//     Ready(
//       SitePath(List(&quot;assets&quot;, &quot;script.js&quot;)),
//       CopyOf(
//         /home/runner/work/subatomic/subatomic/docs/example/assets/script.js
//       )
//     ),
//     Ready(
//       SitePath(List(&quot;assets&quot;, &quot;highlight-scala.js&quot;)),
//       CopyOf(
//         /home/runner/work/subatomic/subatomic/docs/example/assets/highlight-scala.js
//       )
//     ),
// ...
</code></pre>
<h3>Building the site</h3>
<pre><code class="language-scala">site.buildAt(
  destination = os.temp.dir(), 
  overwrite = true
)
</code></pre>
<p>[MDOC.JS] /home/runner/work/subatomic/subatomic/docs/example/pages/scala-js-usage.md, dependencies:  [com.raquo::laminar_sjs1:0.11.0]
[MDOC.JS] [OUT] [34minfo[39m: Compiling 1 file to /tmp/6771558084699655593/scala-js-usage.md
[MDOC.JS] [OUT] [34minfo[39m: Closure: 0 error(s), 0 warning(s)
[MDOC.JS] [OUT] [34minfo[39m: Compiled in 18.68s (0 errors)</p>
<div class='terminal'><pre><code class = 'nohighlight'>Creating&nbsp;site&nbsp;in&nbsp;<span style='color: green'>/tmp/4881143348722803092</span><br /><br /><span style='color: cyan'>example/subatomic-example/index.html</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style='color: red'>^--content--&gt;</span>&nbsp;<span style='color: green'>&lt;html&gt;&lt;head&gt;&lt;title&gt;Home&lt;/title&gt;&lt;link&nbsp;rel="style...</span><br /><span style='color: cyan'>assets/highlight-theme.css</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style='color: red'>^--copy-of--&gt;</span>&nbsp;<span style='color: green'>/home/runner/work/subatomic/subatomic/docs/example/assets/highlight-theme.css</span><br /><span style='color: cyan'>assets/script.js</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style='color: red'>^--copy-of--&gt;</span>&nbsp;<span style='color: green'>/home/runner/work/subatomic/subatomic/docs/example/assets/script.js</span><br /><span style='color: cyan'>assets/highlight-scala.js</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style='color: red'>^--copy-of--&gt;</span>&nbsp;<span style='color: green'>/home/runner/work/subatomic/subatomic/docs/example/assets/highlight-scala.js</span><br /><span style='color: cyan'>assets/highlight.js</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style='color: red'>^--copy-of--&gt;</span>&nbsp;<span style='color: green'>/home/runner/work/subatomic/subatomic/docs/example/assets/highlight.js</span><br /><span style='color: cyan'>assets/styles.css</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style='color: red'>^--copy-of--&gt;</span>&nbsp;<span style='color: green'>/home/runner/work/subatomic/subatomic/docs/example/assets/styles.css</span><br /><span style='color: cyan'>assets/bootstrap.css</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style='color: red'>^--copy-of--&gt;</span>&nbsp;<span style='color: green'>/home/runner/work/subatomic/subatomic/docs/example/assets/bootstrap.css</span><br /><span style='color: cyan'>example/subatomic-example/scala-usage.html</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style='color: red'>^--content--&gt;</span>&nbsp;<span style='color: green'>&lt;html&gt;&lt;head&gt;&lt;title&gt;Scala&nbsp;usage&lt;/title&gt;&lt;link&nbsp;rel...</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style='color: red'>^--processed-from--&gt;</span>&nbsp;<b>ScalaPage(Scala&nbsp;usage,/home/runner/work/subatomic/subatomic/docs/example/page...</b><br /><span style='color: cyan'>example/subatomic-example/scala-js-usage.html</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style='color: red'>^--content--&gt;</span>&nbsp;<span style='color: green'>&lt;html&gt;&lt;head&gt;&lt;title&gt;Scala.js&nbsp;usage&lt;/title&gt;&lt;link&nbsp;...</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style='color: red'>^--processed-from--&gt;</span>&nbsp;<b>ScalaJSPage(Scala.js&nbsp;usage,/home/runner/work/subatomic/subatomic/docs/example...</b><br /><span style='color: cyan'>example/subatomic-example/scala-js-usage.md.js</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style='color: red'>^--copy-of--&gt;</span>&nbsp;<span style='color: green'>/tmp/6771558084699655593/scala-js-usage.md.js</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style='color: red'>^--processed-from--&gt;</span>&nbsp;<b>ScalaJSPage(Scala.js&nbsp;usage,/home/runner/work/subatomic/subatomic/docs/example...</b><br /><span style='color: cyan'>example/subatomic-example/mdoc.js</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style='color: red'>^--copy-of--&gt;</span>&nbsp;<span style='color: green'>/tmp/6771558084699655593/mdoc.js</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style='color: red'>^--processed-from--&gt;</span>&nbsp;<b>ScalaJSPage(Scala.js&nbsp;usage,/home/runner/work/subatomic/subatomic/docs/example...</b></code></pre></div>
</div></div><footer>Â© 2020 Anton Sviridov</footer></body></html>