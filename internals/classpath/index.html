<html><head><title>Subatomic: Mdoc and classpath</title><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/tomorrow-night-blue.min.css" /><script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js"></script><script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/languages/scala.min.js"></script><script>hljs.initHighlightingOnLoad();</script><link rel="stylesheet" href="/assets/tailwind.css" /><script src="/assets/search.js" defer="defer"></script><script src="/assets/search-index.js" defer="defer"></script><link rel="stylesheet" href="/assets/subatomic-search.css" /><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /></head><body onclick="SubatomicSearchFrontend.sayHello()" class="bg-gradient-to-r from-emerald-800 to-sky-700 mt-4 w-full"><header class="flex m-2 mb-4 md:m-auto md:w-11/12 lg:max-w-7xl flex-col md:flex-row md:items-center justify-between mb-2"><div><a class="block text-6xl text-white" href="/">Subatomic</a><p class="text-white">Watch this space, but please don't use it yet</p></div><div id="searchContainer"></div><div class="site-links"><a href="https://github.com/indoorvivants/subatomic"><img class="w-12 opacity-70 hover:opacity-100" src="https://cdn.svgporn.com/logos/github-icon.svg" /></a></div></header><main class="rounded-xl bg-white m-2 mb-4 md:m-auto md:w-11/12 lg:max-w-7xl p-4 flex flex-col-reverse md:flex-row gap-6"><aside class="lg:w-64 shrink-1 lg:shrink-0 grow-0 md:border-r-2 max-w-[300px] border-slate-200 pr-2"><ul class="text-2xl p-4 block"><li><a class="" href="/index.html">Home</a><ul class="text-xl p-2 block"></ul></li><li><a class="font-bold" href="/internals/index.html">Internals</a><ul class="text-xl p-2 block"><li><a class="font-bold" href="/internals/classpath/index.html">Mdoc and classpath</a><ul class="text-lg p-1 block"></ul></li><li><a class="" href="/internals/raw/index.html">Raw API</a><ul class="text-lg p-1 block"></ul></li></ul></li><li><a class="" href="/scalajs/index.html">Scala.js support </a><ul class="text-xl p-2 block"></ul></li><li><a class="" href="/search/index.html">Search </a><ul class="text-xl p-2 block"></ul></li><li><a class="" href="/builders/index.html">Builders</a><ul class="text-xl p-2 block"></ul></li><li><a class="" href="/diagrams/index.html">Diagrams with D2</a><ul class="text-xl p-2 block"></ul></li></ul></aside><article class="grow-4 lg:max-w-6xl markdown"><div><p><strong>This is an in-depth explanation of what Subatomic does when added to your build and why it needs to do so. You don't need to know this in 90% of usage scenarios</strong></p>
<p>When building a static site for a library there are several things
we want the site builder to take care of us:</p>
<ol>
<li>
<p>Markdown documents with Scala examples should be compiled and verified, using the classpath of the library we're documenting</p>
</li>
<li>
<p>We want to be able to pass the version from the build into markdown
documents, so that our installation instructions don't get outdated</p>
</li>
</ol>
<p>Subatomic manually invokes <a href="https://scalameta.org/mdoc/">Mdoc</a> as a separate Java process, so to make it aware of the classpath of the
project we're building, we need to configure the build properly.</p>
<p>Say we have a SBT build as such:</p>
<p><strong>build.sbt</strong></p>
<pre><code class="language-scala">lazy val core = project.in(file(&quot;core&quot;)).settings(...)
lazy val api = project.in(file(&quot;api&quot;)).dependsOn(core)
</code></pre>
<p>And we want to create documentation site for it, where snippets use code from both <code>core</code> and <code>api</code>.</p>
<p>We need to</p>
<ol>
<li>
<p>Create a new <code>docs</code> project:</p>
<pre><code class="language-scala">lazy val docs = project.in(file(&quot;docs&quot;)).dependsOn(core, api)
</code></pre>
</li>
<li>
<p>Enable subatomic SBT plugin:</p>
<p><strong>project/plugins.sbt</strong></p>
<pre><code class="language-scala">  addSbtPlugin(&quot;com.indoorvivants&quot; % &quot;sbt-plugin&quot; % &quot;0.0.7+162-f9b59ad1-SNAPSHOT&quot;)
</code></pre>
<p><strong>build.sbt</strong></p>
<pre><code class="language-scala"> lazy val docs = 
   project
     .in(file(&quot;docs&quot;))
     .dependsOn(core, api)
     .enablePlugins(SubatomicPlugin)
     .settings(
       subatomicInheritClasspath := true, // default, can be omitted
       subatomicBuildersDependency := true, // default, can be omitted
       subatomicMdocVariables := Map(&quot;VERSION&quot; -&gt; version.value) // default, can be omitted
     )
</code></pre>
</li>
</ol>
<p>Doing so leads to two things happening:</p>
<ol>
<li>
<p><code>docs</code> project now has dependency on <code>&quot;com.indoorvivants&quot; %% &quot;subatomic-builders&quot; % &quot;0.0.7+162-f9b59ad1-SNAPSHOT&quot;</code> - which brings all the core things Subatomic will need to build the site</p>
</li>
<li>
<p>A <a href="https://www.scala-sbt.org/1.x/docs/Classpaths.html#Unmanaged+vs+managed">managed resource file</a> called <strong>subatomic.properties</strong> is created (and kept updated)</p>
</li>
</ol>
<p>The <strong>subatomic.properties</strong> file can be accessed by Subatomic when building the site and in our example it will contain the following information:</p>
<pre><code class="language-text">classpath=...
variable.VERSION=...
</code></pre>
<p>I hope <code>variable.VERSION</code> does not need explanation, so let's see what will <code>classpath</code> contain:</p>
<ul>
<li><code>docs</code> dependencies classpath (including Subatomic builders)</li>
<li><code>docs</code> compiled classes</li>
<li><code>core</code> dependencies classpath</li>
<li><code>api</code> dependencies classpath</li>
<li><code>core</code> compiled classes</li>
<li><code>api</code> compiled classes</li>
</ul>
<p>This contains enough information to be passed to Mdoc so that it can
compile and run examples in the documentation.</p>
<p>Note, that because the classpath contains <code>docs</code> own classes, you can add
some class you need for documentation rendering (for example, subatomic itself uses several classes to render ANSI-coloured outputs), and use it from markdown documents.</p>
<p>For example:</p>
<p><strong>docs/src/main/scala/PrettyOutput.scala</strong></p>
<pre><code class="language-scala">object Prettify {
  def apply(out: String) =
    s&quot;&lt;div class='pretty'&gt;$out&lt;/div&gt;&quot;
}
</code></pre>
<p>And in your docs:</p>
<pre><code class="language-markdown">Pretty-printing:

```scala mdoc:passthrough
val result = (1 to 25).mkString(&quot;,&quot;)

println(Prettify(result))
```
</code></pre>
</div></article></main><footer class="text-center m-4 p-4 text-lg text-white font-bold m-auto w-full">Â© 2020-2023 Anton Sviridov</footer><script src="https://www.googletagmanager.com/gtag/js?id=G-9RNQGQHVLB"></script><script> window.dataLayer = window.dataLayer || [];
              function gtag(){window.dataLayer.push(arguments);}
              gtag('js', new Date());

              gtag('config', 'G-9RNQGQHVLB');</script></body></html>