<html><head><title>Subatomic: Example</title><link rel="stylesheet" href="/assets/highlight-theme.css" /><link rel="stylesheet" href="/assets/bootstrap.css" /><link rel="stylesheet" href="/assets/styles.css" /><link rel="shortcut icon" type="image/png" href="/assets/logo.png" /><script src="/assets/highlight.js"></script><script src="/assets/highlight-scala.js"></script><script src="/assets/script.js"></script><meta charset="UTF-8" /></head><body><div class="container"><div class="row"><div class="col-1"></div><div class="col-9"><div class="row"><div class="col-2"><img src="/assets/logo.png" class="img-fluid" style="height: 100;" /></div><div class="col-8"><div class="align-middle"><h1><a href="/">Subatomic</a></h1><small>a tiny, horrible static site builder for Scala</small></div></div><div class="col-2"><p><a href="https://github.com/indoorvivants/subatomic">Github</a></p><p><a href="https://index.scala-lang.org/indoorvivants/subatomic/subatomic">Versions</a></p></div></div><hr /><a class="btn btn-dark" href="/index.html">Home</a> <a class="btn btn-dark" href="/example.html">Example</a><hr /><h1>Example</h1><div><p>We're going build a simple website with statically checked Scala code in Markdown</p>
<p>We will use</p>
<ul>
<li><a href="https://ammonite.io">Ammonite</a>, for writing the entire site builder in a single Scala script</li>
<li><a href="https://scalameta.org/mdoc">Mdoc</a> to compile code examples in markdown</li>
<li><a href="https://lihaoyi.com/scalatags">ScalaTags</a> to generate HTML</li>
</ul>
<p>ScalaTags is not mandated by Subatomic (neither is writing it using Ammonite), but if we're already writing everything in Scala, why not HTML, too :-)</p>
<p>This document is copying the example outlined in the <a href="https://github.com/indoorvivants/subatomic/tree/master/docs/example">repo</a></p>
<h2>Folder structure</h2>
<p>Our example folder structure will look like this:</p>
<pre><code class="language-bash"># static files
assets/
    bootstrap.css
    highlight.js
    hightlight-scala.js
    highlight-theme.css
    script.js
    styles.css
pages/
    index.md # will become index.html
    scala-usage.md # will become scala-usage.html
    scala-js-usage.md # will become scala-js-usage.html
build.sc # static site builder
</code></pre>
<h2>Goals</h2>
<p>What do we want to achieve:</p>
<ul>
<li>
<p>All static assets copied into the built site, accessible via same relative paths</p>
</li>
<li>
<p><code>scala-usage.md</code> will contain some code built with <a href="https://typelevel.org/cats-effect/">Cats-effect</a> library and we want the snippets to be compiled and executed</p>
</li>
<li>
<p><code>scala-js-usage.md</code> will contain some code built with <a href="https://laminar.dev">Laminar</a> library for Scala.js and we want the snippets to become interactive</p>
</li>
<li>
<p>We want to be able to deploy our site to a relative URL of our choosing</p>
<p>This matters when you maintain several sites from the same domain, and want to, say, build a static site for your library at <strong>https://indoorvivants.com/subatomic</strong>, and want to maintain your abandoned blog at <strong>https://indoorvivants.com/blog</strong></p>
<p>All links should work as expected.</p>
</li>
</ul>
<h2>Dependencies and imports</h2>
<pre><code class="language-scala">import $ivy.`com.indoorvivants::subatomic:0.0.2`
import $ivy.`com.lihaoyi::scalatags:0.9.1`
</code></pre>
<pre><code class="language-scala">import com.indoorvivants.subatomic._
import ammonite.ops._
</code></pre>
<h2>Content</h2>
<p>Let's create two folders:</p>
<ul>
<li><code>pages</code> where we will store our markdown pages</li>
<li><code>assets</code> where we will store our static files, like CSS and JS files</li>
</ul>
<p>We're going to reperesent our content model very simply:</p>
<pre><code class="language-scala">sealed trait Content
case class ScalaPage(
    title: String,
    path: os.Path,
    dependencies: Set[String]
) extends Content

case class ScalaJSPage(
    title: String,
    path: os.Path,
    dependencies: List[String]
) extends Content

case class StaticFile(path: os.Path)                  extends Content
case class MarkdownPage(title: String, path: os.Path) extends Content
</code></pre>
<ul>
<li>
<p><code>StaticFile</code> is just that - a file copied without changes from <code>path</code></p>
</li>
<li>
<p><code>MarkdownPage</code> - a page with no Scala snippets that we just want to render as HTML</p>
</li>
<li>
<p><code>ScalaPage</code> - a page that will be compiled using Mdoc (potentially with a list of dependencies)</p>
</li>
<li>
<p><code>ScalaJSPage</code> - same as <code>ScalaPage</code>, but will be compiled into Scala.js (JavaScript) and examples will be embedded.</p>
</li>
</ul>
<p>Let's define our site map, by passing a version of subatomic itself:</p>
<pre><code class="language-scala">object Content {
  def apply(root: os.Path) =
    Assets(root) ++ Pages(root)

  def Assets(root: os.Path): Vector[(SitePath, Content)] = {
    // recursively discovering all files in assets folder
    os.walk(root / &quot;assets&quot;).filter(_.toIO.isFile()).map { path =&gt;
      // make sure relative path on site matches relative path
      // in assets folder
      SiteRoot / path.relativeTo(root) -&gt; StaticFile(path)
    }
  }.toVector

  def Pages(root: os.Path): Vector[(SitePath, Content)] = {
    Vector(
      SiteRoot / &quot;index.html&quot; -&gt; MarkdownPage(
        &quot;Home&quot;,
        root / &quot;pages&quot; / &quot;index.md&quot;
      ),
      SiteRoot / &quot;scala-usage.html&quot; -&gt; ScalaPage(
        &quot;Scala usage&quot;,
        root / &quot;pages&quot; / &quot;scala-usage.md&quot;,
        Set(&quot;org.typelevel::cats-effect:2.2.0&quot;)
      ),
      SiteRoot / &quot;scala-js-usage.html&quot; -&gt; ScalaJSPage(
        &quot;Scala.js usage&quot;,
        root / &quot;pages&quot; / &quot;scala-js-usage.md&quot;,
        List(&quot;com.raquo::laminar_sjs1:0.11.0&quot;)
      )
    )
  }
}
</code></pre>
<ul>
<li>For assets we just recursively walk over the <code>assets</code> folder matching the relative path in our sitemap</li>
<li>We define our Markdown and Scala pages as separate objects</li>
</ul>
<h2>Templates</h2>
<p>Let's create a simple template with Bootstrap styles and Highlight.js dark theme for syntax highlighting:</p>
<pre><code class="language-scala">class Template(linker: Linker) {
  import scalatags.Text.all._
  import scalatags.Text.TypedTag

  def RawHTML(rawHtml: String) = div(raw(rawHtml))

  def main(title: String, content: String): String =
    main(title, RawHTML(content))

  def main(title: String, content: TypedTag[_]): String = {
    html(
      head(
        scalatags.Text.tags2.title(title),
        link(
          rel := &quot;stylesheet&quot;,
          href := linker.rooted(_ / &quot;assets&quot; / &quot;highlight-theme.css&quot;)
        ),
        link(
          rel := &quot;stylesheet&quot;,
          href := linker.rooted(_ / &quot;assets&quot; / &quot;bootstrap.css&quot;)
        ),
        script(src := linker.rooted(_ / &quot;assets&quot; / &quot;highlight.js&quot;)),
        script(src := linker.rooted(_ / &quot;assets&quot; / &quot;highlight-scala.js&quot;)),
        script(src := linker.rooted(_ / &quot;assets&quot; / &quot;script.js&quot;))
      ),
      body(
        div(
          cls := &quot;container&quot;,
          div(
            cls := &quot;row&quot;,
            div(
              cls := &quot;col-9&quot;,
              h1(title),
              content
            )
          )
        )
      )
    ).render
  }
}
</code></pre>
<h3>Assembling</h3>
<p>As subatomic goes through the site map, for each location we need to output a sequence (potentially empty) of site assets:</p>
<pre><code class="language-scala">sealed trait SiteAsset
case class Page(content: String)                      extends SiteAsset
case class CopyOf(source: os.Path)                    extends SiteAsset
case class CreatedFile(source: os.Path, to: SitePath) extends SiteAsset
</code></pre>
<ul>
<li>
<p><code>Page</code> represents content copied into the location verbatim</p>
</li>
<li>
<p><code>CopyOf</code> copies a file from <code>source</code> into the location on the website</p>
</li>
<li>
<p><code>CreatedFile</code> is useful when the processing of a page produces extra resources.</p>
<p>For example, if you're writing Scala.js documents, mdoc will produce 3 files:</p>
<ul>
<li><code>mdoc.js</code> which invokes the JavaScript snippets in your compiled document</li>
<li><code>&lt;filename&gt;.js</code> which contains the code for each of the snippets that were compiled to JavaScript</li>
<li><code>&lt;filename&gt;.md</code> resulting markdown file that references those files</li>
</ul>
</li>
</ul>
<p>Let's write a function that will assemble our site.</p>
<p>The function is fairly long but it's peppered with comments to help
understanding.</p>
<pre><code class="language-scala">def createSite(
    destination: os.Path,
    contentRoot: os.Path = os.pwd,
    siteRoot: SitePath
) = {
  // creating a full site map
  val raw = Content(contentRoot)

  // shift all the content to match the site prefix (siteRoot)
  val content = raw.map {
    case (rawLocation, content) =&gt;
      rawLocation.prepend(siteRoot) -&gt; content
  }

  // helper to resolve links to their correct
  // values with regard to site root
  val linker = new Linker(raw, siteRoot)

  // built-in Mdoc interface
  val mdoc   = new MdocProcessor()
  val mdocJs = new MdocJsProcessor

  val template = new Template(linker)

  // wrapper around flexmark
  val markdown = Markdown(
    // optional:
    //   relativizes all  links in markdown
    //   relative to the path (in this case siteRoot)
    RelativizeLinksExtension(siteRoot.toRelPath)
  )

  Site.build(destination)(content) {
    // handling markdown pages
    case (path, MarkdownPage(title, markdownFile)) =&gt;
      Some(
        Page(
          template.main(title, markdown.renderToString(markdownFile))
        )
      )

    // Processing Scala markdown pages with mdoc
    case (_, ScalaPage(title, mdFile, deps)) =&gt;
      val processed = mdoc.process(mdFile, deps)
      Some(
        Page(
          template.main(title, markdown.renderToString(processed))
        )
      )

    // handling static assets
    case (_, sf: StaticFile) =&gt;
      Some(CopyOf(sf.path))

    // Mdoc for Scala.js returns 3 files
    case (sitePath, ScalaJSPage(title, mdFile, deps)) =&gt;
      val result = mdocJs.process(pwd, mdFile, deps)

      List[SiteAsset](
        Page(
          template.main(title, markdown.renderToString(result.mdFile))
        ),
        CreatedFile(result.mdjsFile, sitePath.up / result.mdjsFile.last),
        CreatedFile(result.mdocFile, sitePath.up / &quot;mdoc.js&quot;)
      )
  }
}
</code></pre>
<p>And this is it. Now we can call this function and it will render the full site at the
destination:</p>
<pre><code class="language-scala">// using temporary folder as destination
createSite(
  destination = os.temp.dir(),
  contentRoot = os.pwd / &quot;docs&quot; / &quot;example&quot;,
  siteRoot    = SiteRoot / &quot;subatomic-example&quot;
)
// 
// Creating site in /tmp/5945282460146831225
// 
// subatomic-example/assets/styles.css
//     ^--copy-of--&gt; /home/runner/work/subatomic/subatomic/docs/example/assets/styles.css
// subatomic-example/assets/highlight.js
//     ^--copy-of--&gt; /home/runner/work/subatomic/subatomic/docs/example/assets/highlight.js
// subatomic-example/assets/bootstrap.css
//     ^--copy-of--&gt; /home/runner/work/subatomic/subatomic/docs/example/assets/bootstrap.css
// subatomic-example/assets/highlight-scala.js
//     ^--copy-of--&gt; /home/runner/work/subatomic/subatomic/docs/example/assets/highlight-scala.js
// subatomic-example/assets/highlight-theme.css
//     ^--copy-of--&gt; /home/runner/work/subatomic/subatomic/docs/example/assets/highlight-theme.css
// subatomic-example/assets/script.js
//     ^--copy-of--&gt; /home/runner/work/subatomic/subatomic/docs/example/assets/script.js
// subatomic-example/index.html
//     ^--content--&gt; &lt;html&gt;&lt;head&gt;&lt;title&gt;Home&lt;/title&gt;&lt;link rel=&quot;style...
//     MarkdownPage(Home,/home/runner/work/subatomic/subatomic/docs/exampl...
// [MDOC]: /home/runner/work/subatomic/subatomic/docs/example/pages/scala-usage.md
// [MDOC]: dependencies org.typelevel::cats-effect:2.2.0
// subatomic-example/scala-usage.html
//     ^--content--&gt; &lt;html&gt;&lt;head&gt;&lt;title&gt;Scala usage&lt;/title&gt;&lt;link rel...
//     ScalaPage(Scala usage,/home/runner/work/subatomic/subatomic/docs/ex...
// MDOC.JS: /home/runner/work/subatomic/subatomic/docs/example/pages/scala-js-usage.md [com.raquo::laminar_sjs1:0.11.0]
// subatomic-example/scala-js-usage.html
//     ^--content--&gt; &lt;html&gt;&lt;head&gt;&lt;title&gt;Scala.js usage&lt;/title&gt;&lt;link ...
//     ScalaJSPage(Scala.js usage,/home/runner/work/subatomic/subatomic/do...
// /subatomic-example/scala-js-usage.md.js
//     ^--created-from--&gt; /tmp/5589770607195697153/scala-js-usage.md.js
// /subatomic-example/mdoc.js
//     ^--created-from--&gt; /tmp/5589770607195697153/mdoc.js
</code></pre>
</div></div></div><div class="row"><div class="col-12"><div class="footer">Â© 2020 Anton Sviridov</div></div></div></div></body></html>